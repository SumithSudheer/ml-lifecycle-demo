version: "3.9"

services:
  # 1️⃣ Data Preprocessing
  preprocess:
    build: .
    container_name: ml_preprocess
    command: python src/preprocess.py
    volumes:
      - ./data:/app/data
      - ./models:/app/models
      - ./artifacts:/app/artifacts
    restart: "no"

  # 2️⃣ Model Training
  train:
    build: .
    container_name: ml_train
    command: python src/train.py
    depends_on:
      - preprocess
    volumes:
      - ./data:/app/data
      - ./models:/app/models
      - ./artifacts:/app/artifacts
    restart: "no"

  # 3️⃣ Model Evaluation
  evaluate:
    build: .
    container_name: ml_evaluate
    command: python src/evaluate.py
    depends_on:
      - train
    volumes:
      - ./data:/app/data
      - ./models:/app/models
      - ./artifacts:/app/artifacts
    restart: "no"

  # 4️⃣ Model Serving (FastAPI)
  api:
    build: .
    container_name: ml_api
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000
    depends_on:
      - evaluate
    ports:
      - "8000:8000"
    volumes:
      - ./models:/app/models
    restart: unless-stopped
